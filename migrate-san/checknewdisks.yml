---
# - name: Check vgname
#   shell: |
#     vgdisplay {{ vgname }}
#   any_errors_fatal: true

- name: Execute scsi rescan
  shell: |
    cd /sys/class/scsi_host
    for s in `ls`
    do
      echo "- - -" > $s/scan
    done

- name: List lsscsi
  shell: |
    {{ lsscsi[ansible_distribution_file_variety] }}
  register: scsi

# Create array disk_map [{'lunid': 'xxx', 'dev': 'yyy'}] for all disks
- name: Create a map disk_map
  include_tasks: disk_map.yml
  loop: "{{ scsi.stdout_lines }}"

# Extract /dev/sdx of new device from nested loop
- set_fact:
    new_dev: "{{ new_dev | default([])  + [item.1.dev] }}"
    new_lunids: "{{ new_lunids | default([])  + [{'dev': item.1.dev, 'id': item.1.lunid}] }}"
  with_nested:
    - "{{ new_luns }}"
    - "{{ disk_map }}"
  when: (item.0|lower) in (item.1.lunid|lower)

- name: Check number of new luns
  fail:
    msg: "Cannot find all new luns. Please check {{ ansible_inventory_sources }}"
  when: ( new_dev | length ) != num_new_luns
  any_errors_fatal: true

- debug:
    msg: 
      - "New LUNs:"
      - "{{ new_lunids }}"
