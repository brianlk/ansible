---
- hosts: oshard
  tasks:
    - name: ensure firewalld
      yum:
        name: firewalld
        state: present
    - name: ensure firewalld started
      service:
        name: firewalld
        state: started
        enabled: yes
    - name: block some services
      firewalld:
        service: "{{ item }}"
        state: disabled
        permanent: yes
        immediate: yes
      loop:
        - cockpit
        - dhcpv6-client
    - name: install netstat
      yum:
        name: "{{ item }}"
        state: present
      loop: [ "sysstat", "net-tools", "telnet" ]
    - name: ensure selinux running
      selinux:
        policy: targeted
        state: enforcing
      register: selinux_status
    - name: verify if reboot needed
      debug:
        msg: "Reboot needed: {{ selinux_status.reboot_required }}"
      changed_when: "{{ selinux_status.reboot_required | bool }}"
      notify: reboot_host
    - name: harden kernel params
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_set: yes
        state: present
        reload: yes
        sysctl_file: /etc/sysctl.d/90-kernel.conf
      loop:
        - name: kernel.randomize_va_space
          value: 2
        - name: kernel.dmesg_restrict
          value: 1
        - name: kernel.perf_event_paranoid
          value: 2
    - name: Harden network parameters
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: '{{ item.value }}'
        sysctl_set: yes
        state: present
        reload: yes
        sysctl_file: /etc/sysctl.d/90-net.conf
      loop:
       - name: net.ipv4.tcp_syncookies
         value: 1
       - name: net.ipv4.conf.default.log_martians
         value: 1
       - name: net.ipv4.conf.all.log_martians
         value: 1
       - name: net.ipv4.conf.all.accept_source_route
         value: 0
       - name: net.ipv4.conf.default.accept_source_route
         value: 0
       - name: net.ipv6.conf.all.accept_source_route
         value: 0
       - name: net.ipv6.conf.default.accept_source_route
         value: 0
    - name: Disable ip forwarding
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: '{{ item.value }}'
        sysctl_set: yes
        state: present
        reload: yes
        sysctl_file: /etc/sysctl.d/90-ip.conf
      loop:
      - name: net.ipv4.ip_forward
        value: 0
      - name: net.ipv6.conf.all.forwarding
        value: 0


  handlers:
  - name: reboot_host
    reboot:
      reboot_timeout: 600


